<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>User Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container py-4">
  <h4>User Management</h4>

  <div class="card p-3 mb-3">
    <h5>Create New User</h5>
    <form id="createUserForm">
      <div class="row g-2">
        <div class="col-md-3"><input class="form-control" name="username" placeholder="username" required></div>
        <div class="col-md-3"><input class="form-control" name="password" placeholder="password" required></div>
        <div class="col-md-2">
          <select class="form-select" name="role">
            <option value="asha">ASHA</option>
            <option value="supervisor">Supervisor</option>
          </select>
        </div>
        <div class="col-md-2"><input class="form-control" name="email" placeholder="email"></div>
        <div class="col-md-2"><input class="form-control" name="phone" placeholder="phone"></div>
      </div>
      <div class="mt-2">
        <button class="btn btn-primary btn-sm">Create</button>
      </div>
    </form>
  </div>

  <table class="table table-sm">
    <thead><tr><th>ID</th><th>Username</th><th>Role</th><th>Email</th><th>Phone</th><th>Created</th><th>Action</th></tr></thead>
    <tbody id="usersTbody">
      {% for u in users %}
      <tr data-id="{{ u.id }}">
        <td>{{ u.id }}</td>
        <td>{{ u.username }}</td>
        <td>{{ u.role }}</td>
        <td>{{ u.email }}</td>
        <td>{{ u.phone }}</td>
        <td>{{ u.created_at }}</td>
        <td><button class="btn btn-sm btn-danger del" data-id="{{ u.id }}">Delete</button></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <a href="/dashboard" class="btn btn-outline-primary">Back to Dashboard</a>
</div>

<script>
document.getElementById('createUserForm').addEventListener('submit', function(e){
  e.preventDefault();
  const fd = new FormData(this);
  const obj = {};
  fd.forEach((v,k)=>obj[k]=v);
  fetch('/api/create_user', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(obj)
  }).then(r=>r.json()).then(j=>{
    if(j.ok) location.reload();
    else alert(j.message || 'Failed');
  })
});

document.querySelectorAll('.del').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    if(!confirm('Delete user?')) return;
    const id = btn.dataset.id;
    fetch('/api/delete_user', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({id: id})
    }).then(r=>r.json()).then(j=>{
      if(j.ok) location.reload(); else alert('Failed');
    })
  })
});
</script>
</body>
</html>
